<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/web.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/validations.js~ValidationError.html">ValidationError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/validations.js~ValidationErrors.html">ValidationErrors</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-After">After</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Before">Before</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Bind">Bind</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Inject">Inject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Injectable">Injectable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Property">Property</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-PropertySources">PropertySources</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Self">Self</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-SmartPooling">SmartPooling</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Resolve">Resolve</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ResolveWith">ResolveWith</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-register">register</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-resolve">resolve</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-load">load</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Aggregate">Aggregate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-IN">IN</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-OUT">OUT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Schema">Schema</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ValidateSchema">ValidateSchema</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-RequiresAuth">RequiresAuth</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-RequiresRole">RequiresRole</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Context">Context</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Controller">Controller</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-HttpError">HttpError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-HttpStatus">HttpStatus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Middleware">Middleware</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Request">Request</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Route">Route</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Session">Session</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-start">start</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Adapter">Adapter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Component">Component</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Module">Module</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Project">Project</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Service">Service</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Singleton">Singleton</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Validate">Validate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Transform">Transform</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AllRequests">AllRequests</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DeleteRequest">DeleteRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-GetRequest">GetRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ListRequest">ListRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-OptionsRequest">OptionsRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PatchRequest">PatchRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PostRequest">PostRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Project">Project</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PutRequest">PutRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Validate">Validate</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/web.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">const debug = require(&apos;debug&apos;)(&apos;primavera:web&apos;)
import _ from &apos;lodash&apos;
// import express from &apos;express&apos;
import {Before,After} from &apos;./core&apos;


/**
 * Lazy initialization of actual express routes.
 */
const initialization_stack = []
const router = new Proxy({}, {
    get(target, what) {
        return function() {
            debug(`Adding instruction to initialization stack: ${what} (${arguments})`)
            initialization_stack.push({method: what, args: Array.from(arguments)})
        }
    }
})

// export function start(app, path) {
//     const _router = express.Router()
//     for (let instruction of initialization_stack) {
//         _router[instruction.method].apply(_router,instruction.args)
//     }
//     app.use(path || &quot;/&quot;, _router)
// }
// 
export function start(router) {
    debug(&apos;Initializing routes...&apos;)
    for (let instruction of initialization_stack) {
        router[instruction.method].apply(router,instruction.args)
        debug(&apos;Added route &apos;, instruction.args)
    }
}

/**
 * Just bridge functions to already existing functionality.
 */
export const Validate = Before
export const Project = After


export function Session(prop) {
    var path = [&apos;$request.session&apos;]
    if (prop &amp;&amp; prop.trim()) path.push(prop)
    path = path.join(&apos;.&apos;)

    return Context(path)
}

export function Request(prop) {
    var path = [&apos;$request&apos;]
    if (prop &amp;&amp; prop.trim()) path.push(prop)
    path = path.join(&apos;.&apos;)

    return Context(path)
}


/**
 * Set HTTP status on successful response.
 * @param {[type]} status [description]
 */
export function HttpStatus(status) {
    return function (target, name, descriptor) {
        debug(`Setting HttpStatus ${status} on ${descriptor.name} success`, descriptor)
        descriptor.value.$$httpSuccessStatus = status 
        return descriptor
    }
}
_.merge(HttpStatus, {
    OK: 200,
    CREATED: 201,
    ACCEPTED: 202,
    NON_AUTHORITATIVE: 203,
    NO_CONTENT: 204,
    RESET_CONTENT: 205,
    PARTIAL_CONTENT: 206,
    MULTI_STATUS: 207,
    MULTIPLE_CHOICES: 300,
    MOVED_PERMANENTLY: 301,
    FOUND: 302,
    SEE_OTHER: 303,
    NOT_MODIFIED: 304,
    USE_PROXY: 305,
    TEMPORARY_REDIRECT: 307,
    PERMANENT_REDIRECT: 308,
    BAD_REQUEST: 400,
    UNAUTHORIZED: 401,
    PAYMENT_REQUIRED: 402,
    FORBIDDEN: 403,
    NOT_FOUND: 404,
    METHOD_NOT_ALLOWED: 405,
    NOT_ACCCEPTABLE: 406,
    PROXY_AUTH_REQUIRED: 407,
    REQUEST_TIMEOUT: 408,
    CONFLICT: 409,
    GONE: 401,
    PRECONDITION_FAILED: 412,
    EXPECTATION_FAILED: 417,
    SERVER_ERROR: 500,
    NOT_IMPLEMENTED: 501,
    BAD_GATEWAY: 502,
    SERVICE_UNAVAILABLE: 503,
    GATEWAY_TIMEOUT: 504
})

export function HttpError() {
    return function(target, name, descriptor) {
        return descriptor
    }
}

for (let statusCode in HttpStatus) {
    const camelized = _.camelCase(statusCode)
    HttpStatus[camelized] = function(message) {
        let status = HttpStatus[statusCode]
        return {message, status}
    }
    HttpError[camelized] = function(message) {
        throw HttpStatus[camelized](message)
    }
}


/**
 * Register within a given Controller/Method pair.
 * Router registration will register the route in ExpressJS and transform
 * payload, query parameters and response accordingly.
 */
export function Route(routes) {

    if (!Array.isArray(routes)) routes = [routes]

    return function(target, name, descriptor) {
    	if (!descriptor) throw new Error(&apos;@Route can only be set on a method.&apos;)

        for (let route of routes) {
        	const parts = route.match(/[a-zA-Z0-9-_./\*\+:+]+/ig)
        	if (parts.length &lt; 2) throw new Error(`${route} is not a valid routing expression.`)

            const method = parts[0].toLowerCase()
            let path = parts[1] || &apos;&apos;
            if (path.indexOf(&apos;/&apos;)==0) path = path.substring(1)

            debug(`@Route ${route} will be attached to ${target.constructor.name}::${name}()`)
             
            if (!target.$$routes) target.$$routes = []

            target.$$routes.push({method, path, _fn: name || descriptor })
            target.$$routes = target.$$routes
        }

        return descriptor
    }
}


// -------------------------------------------------------------
// Additional exports for syntax sugar
// -------------------------------------------------------------
export const GetRequest     = routeWith(&apos;GET&apos;)
export const PostRequest    = routeWith(&apos;POST&apos;)
export const PutRequest     = routeWith(&apos;PUT&apos;)
export const PatchRequest   = routeWith(&apos;PATCH&apos;)
export const ListRequest    = routeWith(&apos;LIST&apos;)
export const DeleteRequest  = routeWith(&apos;DELETE&apos;)
export const OptionsRequest  = routeWith(&apos;OPTIONS&apos;)
export const AllRequests    = routeWith(&apos;USE&apos;)
_.merge(Route, {USE: AllRequests, GET: GetRequest,POST: PostRequest, PUT: PutRequest, PATCH: PatchRequest, LIST: ListRequest, DELETE: DeleteRequest, OPTIONS: OptionsRequest})

// Build command-based @Route instructions
function routeWith(command) {
    return function(path, config) {
        return Route(`${command} ${path || &apos;/&apos;}`, config)
    }
}

/**
 * Register a given class as an express controller component.
 */
export function Controller(config) {
    var prefix = config &amp;&amp; config.prefix || &apos;&apos;;
    if (prefix &amp;&amp; prefix.indexOf(&apos;/&apos;)!=0) prefix = `/${prefix}`

    return function (target, name, descriptor) {
        if (!target) throw new Error(`@Controller decorator can only be used in a class.`)

        const routes = target.$$routes || target.prototype.$$routes || []
        for (let route of routes) {
            const absolute = [prefix,route.path].join(&apos;/&apos;)
            debug(`@Controller is setting route ${route.method} -&gt; ${absolute}`)

            router[route.method.toLowerCase()](absolute, async function (req,res, next) {
                try {
                    const instance = (target.constructor) ? new target() : target //Container.get(target.$$name || target.constructor.name)
                    // Inject request context if required.
                    instance.$$context = {$request:req,$response:res, $this: instance}

                    const merged = [Object.assign({}, req.query, req.params), req.body] // named url params take precedence
                    debug(`Invoking method ${target.name}::${route._fn}()`)

                    const _fn = instance[route._fn]
                    const result = await _fn.apply(instance, merged)

                    // If is a promise, treat as such.
                    debug(&quot;Checking if there&apos;s a specific http-status to be sent on success: &quot;, _fn.$$httpSuccessStatus)
                    if (_fn.$$httpSuccessStatus)
                        res.status(_fn.$$httpSuccessStatus)

                    return res.send(result)
                    // next(req, res)
                }
                catch (e) {
                    console.error(e)
                    res.status(e.status || 500)
                    return res.send(e.errors || e.message)
                }
            })

        }

        debug(`@Controller ${target.name} was setup and routes were added.`)
        return target;
    }
}


/**
 * Set a given request context attribute as a controller class attribute.
 */
export function Context(path) {
    return function (target, name, descriptor) {
        debug(`@Context binding points to ${path} in ${target.name}::${name}`)
        
        const isFunction = !!descriptor.value
        debug(&quot;@Context use function decorator: &quot;, isFunction)
        const overwrite = isFunction ? &apos;value&apos; : &apos;get&apos;
        var _fn = descriptor[overwrite]
        descriptor[overwrite] = function() {
            let ctxval;
            if (!path) ctxval = this.$$context
            if (typeof path === &apos;string&apos;) { //  instanceof String) {
                // debug(`In @Context(${path}) {this} object is `, this)
                ctxval = _.get(this.$$context, path)
            }
            if (typeof path === &apos;object&apos;) {
                ctxval = {}
            }

            if (isFunction) return _fn.apply(this, [ctxval])
            return ctxval
        }
    }
}


/**
 * Register a given class as an express middleware component.
 */
export function Middleware(config) {
    var prefix = config &amp;&amp; config.prefix || &apos;&apos;;
    if (prefix &amp;&amp; prefix.indexOf(&apos;/&apos;)!=0) prefix = `/${prefix}`

    return function (target, name, descriptor) {
        if (!target) throw new Error(`@Middleware decorator can only be used in a class.`)

        const routes = target.$$routes || target.prototype.$$routes || []
        for (let route of routes) {
            const absolute = [prefix,route.path].join(&apos;/&apos;)
            debug(`@Middleware is setting route ${route.method} -&gt; ${absolute}`)

            if (route.method==&apos;*&apos;) route.method = &apos;use&apos;

            router[route.method.toLowerCase()](absolute, async function(req,res,next) {
                const instance = (target.constructor) ? new target() : target 
                // Inject request context if required.
                instance.$$context = {$request:req,$response:res,$this: instance}

                try {
                    const result = await instance[route._fn].apply(instance, [req, res])
                    return await next()
                }
                catch (e) {
                    console.error(e)
                    res.status(e.status || 500)
                    return res.send(e.errors || e.message)
                }
            })
        }

        debug(`@Middleware ${target.name} was setup and routes were added.`)
        return target;
    }
}</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
