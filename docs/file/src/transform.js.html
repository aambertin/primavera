<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/transform.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/validations.js~ValidationError.html">ValidationError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/validations.js~ValidationErrors.html">ValidationErrors</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-After">After</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Before">Before</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Bind">Bind</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Inject">Inject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Injectable">Injectable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Property">Property</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-PropertySources">PropertySources</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Self">Self</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-SmartPooling">SmartPooling</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Resolve">Resolve</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ResolveWith">ResolveWith</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-register">register</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-resolve">resolve</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-load">load</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Aggregate">Aggregate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-IN">IN</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-OUT">OUT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Schema">Schema</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ValidateSchema">ValidateSchema</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-RequiresAuth">RequiresAuth</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-RequiresRole">RequiresRole</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Context">Context</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Controller">Controller</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-HttpError">HttpError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-HttpStatus">HttpStatus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Middleware">Middleware</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Request">Request</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Route">Route</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Session">Session</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-start">start</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Adapter">Adapter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Component">Component</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Module">Module</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Project">Project</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Service">Service</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Singleton">Singleton</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Validate">Validate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Transform">Transform</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AllRequests">AllRequests</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DeleteRequest">DeleteRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-GetRequest">GetRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ListRequest">ListRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-OptionsRequest">OptionsRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PatchRequest">PatchRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PostRequest">PostRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Project">Project</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PutRequest">PutRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Validate">Validate</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/transform.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// const debug = require(&apos;debug&apos;)(&apos;@expression/core:decorators/models&apos;)
import { default as debuglib } from &apos;debug&apos;
import _ from &apos;lodash&apos;
import { default as jsonschema } from &apos;jsonschema&apos;

const debug = debuglib(&apos;@expression/core:decorators/transform&apos;)

/**
 * Apply transformations on method arguments.
 */
export const Transform = { IN, OUT }
export default Transform


/**
 * Map/transform function arguments before actual function call.
 */
export function IN() {
    const transformers = Array.from(arguments)
    return function(target, name, descriptor) {
        if (!descriptor) throw new Error(`@Transform operations can only be performed on method arguments.`)
        
        const fn = descriptor.value
        descriptor.value = async function() {
            const args = Array.from(arguments)
            debug(`Called @Transform.IN with ${transformers.length} transformers for ${args.length} arguments`)
            const values = await transform_in(transformers, args)
            debug(`@Transform.IN on ${name} returned: `, values)
            return await fn.apply(this, values)
        }

        return descriptor
    }
}

/**
 * Map/transform a function return value.
 * If the return value of the function is an array, the transform functions
 * will be applied to each element of the array.
 */
export function OUT() {
    const transformers = Array.from(arguments)
    let attribute
    if (transformers[0] &amp;&amp; typeof transformers[0] === &apos;string&apos;) //:
        attribute = trasformers.shift()

    return function(target, name, descriptor) {
        if (!descriptor) throw new Error(`@Transform operations can only be performed on method response.`)
        debug(`Configuring @Transform on ${target.name||&apos;&apos;}::${descriptor.name}`)

        const fn = descriptor.value
        descriptor.value = async function() {
            const args = Array.from(arguments)
            const data = await fn.apply(this, args)
            debug(&quot;Received data to transform&quot;, data)
            return await transform(transformers, data)
        }

        return descriptor
    }
}


/**
 * Map/transform a function return value.
 * If the return value of the function is an array, the transform functions
 * will be applied to each element of the array.
 */
export function Aggregate() {
    const aggregators = Array.from(arguments)
    let attribute
    if (aggregators[0] &amp;&amp; typeof aggregators[0] === &apos;string&apos;) //:
        attribute = aggregators.shift()

    return function(target, name, descriptor) {
        if (!descriptor) throw new Error(`@Aggregate operations can only be performed on method resposne.`)
        debug(`Configuring @Aggregate on ${target.name||&apos;&apos;}::${descriptor.name}`)

        const fn = descriptor.value
        descriptor.value = async function aggregate() {
            const ops = []
            const args = Array.from(arguments)
            const data = await fn.apply(this, args)

            for (let aggregator of aggregators) {
                debug(`@Aggregate is running aggregator: ${aggregator.name}`)
                ops.push(aggregator((attribute &amp;&amp; _.get(data, attribute) || data)))
            }

            for (let op of ops) {
                if (attribute) _.merge(_.get(data, attribute), await op)
                else _.merge(data, await op)
            }
            
            return data
        }

        return descriptor
    }
}


/**
 * Support function for actual IN parameters transformations (N-N)
 */
async function transform_in(transformers = [], args = []) {
    // array explosion
    if (!Array.isArray(args)) throw new Error(`Argument list in @Transform.IN must be an array. Got: ${typeof args}`)

    const res = []
    for (let arg of args) {
        const transformer = transformers.shift()
        let val
        if (transformer) val = transform(transformer, arg)
        else val = arg

        res.push(val)
    }
    return await res
}


/**
 * General trasnformation support function (N-1)
 */
async function transform(transformers = [], data) {
    if (!transformers) return data // return raw data if there are no transformers to be applied.

    // data explosion for array processing scenarios
    if (Array.isArray(data)) {
        const res_arr = []
        for (let record of data) {
            res_arr.push(transform(transformers, record))
        }

        return await res_arr // await for all data record to be transformed
    }

    // transform logic
    if (!Array.isArray(transformers)) transformers = [transformers]

    let res = data
    for (let transformer of transformers) {
        debug(`Applying transformer ${transformer.name} to data`, data)
        res = await transformer(data)
    }
    debug(&quot;Transformed data: &quot;, res)
    return res
}</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
